---
title: "foo"
subtitle: ""
author: ""
output:
  xaringan::moon_reader:
    lib_dir: libs
    seal: false
    css: 
      - assets/css/theme.css
      - assets/css/extra.css
      - assets/css/tachyons.min.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r, include = FALSE}
CHAR_WIDTH = 100
FIG_WIDTH = 9
FIG_HEIGHT = 4

library(paradox)
library(mlr3)
library(magrittr)
options(htmltools.dir.version = FALSE, width=80)
requireNamespace("fansi")
requireNamespace("icon") # remotes::install_github("ropenscilabs/icon")
options(
  crayon.enabled = TRUE,
  datatable.print.class = FALSE,
  datatable.print.keys = FALSE,
  width = CHAR_WIDTH
)
knitr::opts_chunk$set(
  #comment = NA,
  comment = "#",
  tidy.opts=list(width.cutoff=80),
  eval = T,
  width = CHAR_WIDTH,
  fig.height = FIG_HEIGHT,
  fig.width = FIG_WIDTH,
  fig.align = "center",
  dev = "svg",
  out.width = "90%",
  cache = FALSE # because it does not work wiht mlr3/R6
)
lgr::get_logger("mlr3")$set_threshold("warn")
```

class: middle left hide-count

<img src="https://raw.githubusercontent.com/mlr-org/mlr/master/man/figures/logo_navbar.png">

.avatars[

<img src="avatars/michel.jpg", max.width = "100%">
<img src="avatars/bernd.jpg", max.width = "100%">
<img src="avatars/jakob.jpg", max.width = "100%">
<img src="avatars/patrick.jpg", max.width = "100%">
<img src="avatars/martin.jpg", max.width = "100%">

]

.talk-meta[
.talk-title[
# Reproducible machine learning workflows
]

.talk-author[
Michel Lang, Bernd Bischl, **Jakob Richter**, **Patrick Schratz**, Martin Binder
]

.talk-location.i[
whyR conference, Warsaw
]

.talk-date.i[
September 27th, 2019
]
]

---

# What is machine learning?

Supervised 
* **Classification**
  * Binary
  * Multiclass
* **Regression**
* Survival (Time To Event)

Unsupervised
* Clustering

---

# What is a machine learning pipeline?

```{r fig_pipelines, echo = FALSE}
knitr::include_graphics("assets/ml-workflow.png", dpi = 30)
```

`r icon::fa("question-circle")` Why are pipelines necessary?  

`r icon::fa("exclamation-circle")` Gives reproducible process that can be validated (through nested cross-validation).

---

# Machine Learning in R

The **good** news:

- CRAN serves hundreds of packages for machine learning

- Many packages for single specific ML-methods
  - `randomForest`, `ranger`
  - `e1070::svm`
  - `kknn`
  - `xgboost`
  - ...
- Often compliant to the unwritten interface definition:

  ```r
  model = fit(target ~ ., data = train.data, ...)
  predictions = predict(model, newdata = test.data, ...)
  ```

---

# Machine Learning in R

The **bad** news:
- Some packages' API is "just different"

- Functionality is always package or model-dependent, even though the procedure might be general

- Capabilities are often not clearly documented
  - "Can this method handle missing/categorical values?"
  
- ML workflow not standardized in R
  - Cross-Validation
  - Hyperparameter Tuning
  - Self implementations are error prone

---

# Motivation: (old) mlr

- Unified interface for the basic building blocks: **tasks**, **learners**,
  **hyperparameters**.
  
- Simplifying repetitive tasks:
  - cross-validation
  - hyperparameter tuning
  - comparison of different methods
  - parallelization  
  
- Project homepage: https://github.com/mlr-org/mlr
- 8-10 main developers
  - even more contributors
  - 5 GSOC projects since 2015
  
- About 30K lines of code, 8K lines of unit tests

---

# What (old) mlr became (1/2)

Meta framework for everything machine learning (visualization, tuning, feature selection, preprocessing, bagging, ensembles, ...)

* Monolithic package

* Interfaces > 150 learners  

  `r icon::fa("arrow-right")` Dependencies (direct / recursive): 119 / 1436  
  `r icon::fa("arrow-right")` Unit tests take > 2h  
  `r icon::fa("arrow-right")` Package developers changed their API and (unknowingly) broke mlr  
  
* High barrier for new contributors

---

# What (old) mlr became (2/2)

Meta framework for everything machine learning (visualization, tuning, feature selection, preprocessing, bagging, ensembles, ...)

* S3 reaches its limitations in larger software projects

* Many specialized and "hard to find" functions `getBMRAggrPerformances()`

* Only works on in-memory data

* No nested parallelization

---

# mlr3

Overcome limitations of S3 with the help of **R6**
  * Truly object-oriented (OO): data and methods together
  * Inheritance
  * Reference semantics
  
Embrace **data.table**, both for arguments and for internal data structures
  * Fast operations for tabular data
  * Better support for list columns to arrange complex objects in a tabular structure
  * Reference semantics
  
Be **light on dependencies**. Direct and recursive dependencies:
  * `R6`, `data.table`, `Metrics`, `lgr`
  * Some self-maintained packages (`backports`, `checkmate`, ...)

---

# Consequences

* steeper learning curve to learn mlr3

* multiple packages for different functionality
  * mlr3learners
  * mlr3pipelines
  * mlr3tuning
  * mlr3filters
  * mlr3viz
  * ...
  
* easier extendable
  * inherit classes and overwrite functionality

---
class: inverse, center, middle

# mlr3

---

# Building Blocks

```{r fig_building_blocks, echo = FALSE}
knitr::include_graphics("assets/ml_abstraction_colors.svg.png", dpi = 50)
```

---

# Tasks

`r icon::fa("arrow-right")` Create your own task

```{r}
TaskClassif$new("iris", iris, target = "Species")
```
    
`r icon::fa("arrow-right")` Retrieve a predefined task from the task dictionary

```{r}
mlr_tasks
task = mlr_tasks$get("iris")
```

---

# Learner

`r icon::fa("arrow-right")` Retrieve a predefined learner from the learner dictionary

```{r, out.width=CHAR_WIDTH}
mlr_learners
```

`r icon::fa("info-circle")` More learners are available after loading `mlr3learners`.

---

# Learner

```{r}
learner = lrn("classif.rpart")
learner
```

---

# Learner

`r icon::fa("arrow-right")` Querying and setting hyperparameters

```{r}
# query
learner$param_set
# set
learner$param_set$values = list(xval = 0, cp = 0.1)
```
    
---

# Learner

`r icon::fa("arrow-right")` Training
```{r}
task = tsk("iris")
learner$train(task, row_ids = seq(1, to = 150, by = 2))
```

`r icon::fa("info-circle")` This changes the learner in-place; the model is now stored inside the learner.

---

# Learner

`r icon::fa("arrow-right")` Accessing the learner model

```{r}
learner$model
```

---

# Learner

`r icon::fa("smile")` Unified interface, to acess *feature importance*, *selected features* etc. for all learners. 

```{r}
learner$importance()
learner$selected_features()
```

---

# Prediction

`r icon::fa("arrow-right")` Generate predictions or confusion matrices

```{r}
p = learner$predict(task, row_ids = seq(2, to = 150, by = 2))
head(as.data.table(p), 3)
```

```{r}
p$confusion
```

---

# Measure

`r icon::fa("arrow-right")` Retrieve a predefined measure from the measure dictionary

```{r}
(measure = mlr_measures$get("classif.acc"))
mlr_measures
```

---

# Measure

`r icon::fa("arrow-right")` Calculate performance
```{r}
p$score(measure)
```

---

# Resample

`r icon::fa("arrow-right")` Automate train/test splitting and predict with *resampling*.

```{r}
mlr_resamplings
resampling = rsmp("cv", folds = 3)
rr = resample(task, learner, resampling)
```

---

# Resample

.code75[
```{r, eval = T}
rr$score() 
```

]

```{r}
rr$aggregate() 
```

`r icon::fa("info-circle")` The default measure for classif tasks is the *classification error*.

---

# Recap: Building Blocks

```{r fig_building_blocks, echo = FALSE}
```

---

# Dictionaries

Dictionaries store often used objects.

|Dictionary|Helper|  |
|:---------|:-----|--|
|`mlr_tasks`|`tsk()`|Example tasks (iris, spam, ...)|
|`mlr_task_generators`|`tgen()`|Synthetic task generators|
|`mlr_learners`|`lrn()`|learners|
|`mlr_measures`|`msr()`|measures (acc, auc, mse, ...)|
|`mlr_resamplings`|`rsmp()`|resampling strategies (cv, holdout, bootstrap, ...)|

`r icon::fa("info-circle")` Dictionaries can get populated by add-on packages (e.g. `mlr3learners`).

---

# Recap: Example Train/Test

```{r, include = FALSE}
library(mlr3)
set.seed(1)
```

```{r}
# Create learning task
task_iris = TaskClassif$new(id = "iris", backend = iris, 
  target = "Species")

# Load learner from dictionary
learner = lrn("classif.rpart")

# Set learner hyperparameter
learner$param_set$values$cp = 0.01

# Create train/test split
train_set = sample(task_iris$nrow, 0.8 * task_iris$nrow)
test_set = setdiff(seq_len(task_iris$nrow), train_set)

# Train the model
learner$train(task_iris, row_ids = train_set)

# Predict data
prediction = learner$predict(task_iris, 
  row_ids = test_set)
```

---

# Example Train/Test (cont.)

.code85[
```{r}
prediction
# calculate performance
prediction$confusion
prediction$score(msr("classif.acc"))
```
]

---

# Recap: Example Resample

`r icon::fa("arrow-right")` Resampling Object

.font25[
```{r}
cv3 = rsmp("cv", folds = 3)
```

Splits into train/test are efficiently stored and can be accessed with `$train_set(i)` and `$test_set(i)`.

`r icon::fa("arrow-right")` Resample a **regression tree** on the "Boston housing" data using a **3-fold CV**

```{r}
# string -> object conversion via dictionary
rr = resample(tsk("boston_housing"), lrn("regr.rpart"), cv3)
```

`r icon::fa("arrow-right")` Aggregated performance

```{r}
rr$aggregate(msr("regr.mse"))
```
]

---
class: inverse, center, middle

# Benchmarking

---

# Benchmarking

`r icon::fa("info-circle")` `benchmark()` runs `resample()` on multiple learners and  tasks

`r icon::fa("arrow-right")` A sensible choice is usually the combination of all components in an exhaustive grid:

```{r benchmark1_design}
design = benchmark_grid(
  tasks = list(tsk("iris"), tsk("spam")), resamplings = rsmp("cv"),
  learners = list(lrn("classif.featureless"), lrn("classif.rpart"))
)
design
```

---

# Benchmarking (cont.)

`r icon::fa("arrow-right")` Execute `benchmark()` on the defined design

```{r benchmark1, eval = T}
bmr = benchmark(design, store_models = TRUE)
bmr
```

---

# Benchmarking (cont.)

`r icon::fa("arrow-right")` Calculate aggregated performance measure

```{r, eval = T}
aggr = bmr$aggregate(msr("classif.acc"))
aggr[, 3:7]
```

---

# Benchmarking (cont.)

`r icon::fa("arrow-right")` Retrieve objects from the `BenchmarkResult`:

```{r, eval = T}
# ResampleResult from 2nd configuration in the design 
# (rpart on iris)

rr = bmr$resample_result(2)

# confusion matrix
rr$prediction()$confusion
```

```{r, eval = T}
# Average feature importance
sapply(rr$data$learner, function(x) x$importance()) %>% 
  apply(1, mean)
```

---
class: inverse, center, middle

# Tuning

---

# Tuning

* Algorithms: 
  - _Grid Search_
  - _Random Search_ 
  - _Simulated Annealing_

* In process
  - _Bayesian Optimization_
  - _iterated F-racing_
  - _EAs_

* Budget via class `Terminator`: iterations, performance, runtime, real time

* Nested resampling via class `AutoTuner`

---

# Tuning

```{r at_resample, eval = T}
library(mlr3learners)
library(mlr3tuning)

ps = ParamSet$new(list(
  ParamInt$new("min.node.size", lower = 1, upper = 10),
  ParamInt$new("mtry", lower = 10, upper = 50)
))

at = AutoTuner$new(
  learner = lrn("classif.ranger"),
  resampling = rsmp("cv", folds = 3),
  measures = msr("classif.acc"),
  tune_ps = ps, 
  terminator = term("evals", n_evals = 2), 
  tuner = tnr("random_search")
)
```

---

# Tuning

```{r, eval = T}
resample(tsk("spam"), learner = at, rsmp("holdout"))
```

---

# `AutoTuner` in Benchmark

.pull-left[
`r icon::fa("arrow-right")` Compare tuned learner vs. default learner:

```{r at_benchmark, eval = T}
design = benchmark_grid(
  tasks = tsk("spam"), 
  learners = list(
    at, 
    lrn("classif.ranger")
  ), 
  resamplings = rsmp("cv", 
    folds = 5))
bmr = benchmark(design)
```

`r icon::fa("info-circle")` _mlr3viz_ package contains `autoplot()` functions for some `mlr3` objects.

```{r, eval=F}
library(mlr3viz)
autoplot(bmr)
```


]

.pull-right[

```{r eval = T, fig_at_benchmark, fig.width=0.5*FIG_WIDTH, echo = FALSE}
library(mlr3viz)
autoplot(bmr)
```
]

---

class: inverse, center, middle

# mlr3 Advanced Usage

---

# Internal Data Structure

All result objects (`resample()`, `benchmark()`, tuning, ...) share the same structure:

.code75[
```{r}
as.data.table(rr)
```
]

---

# Internal Data Structure

#### Combining `R6` and `data.table`
* Not the objects are stored, but pointers to them

* Inexpensive to work on:
  * `rbind()`: copying R6 objects &wedgeq; copying pointers
  * `cbind()`: `data.table()` over-allocates columns, no copies
  * `[i, ]`: lookup row (possibly hashed), create a list of pointers
  * `[, j]`: direct access to list element

---

# Control of Execution

`r icon::fa("arrow-right")` Parallelization
```{r, eval = FALSE}
future::plan("multicore")
benchmark(grid)
```

* runs each resampling iteration as a job

* also allows nested resampling (although not needed here)

---

# Control of Execution

`r icon::fa("arrow-right")`  Encapsulation

```{r, eval = FALSE}
learner$encapsulate = c(train = "callr", predict = "callr")
```

* Spawns a separate R process to train the learner

* Learner may segfault without tearing down the master session

* Logs are captured

* Possibility to have a fallback learner to create predictions

---

# Out-of-memory Data

Task stores data in a `DataBackend`:
  * `DataBackendDataTable`: Default backend for dense data (in-memory)
  
  * `DataBackendMatrix`: Backend for sparse numerical data (in-memory)
  
  * `mlr3db::DataBackendDplyr`: Backend for many DBMS (out-of-memory)
  
  * `DataBackendCbind`: Combine backends thorugh `task$cbind(backend)` (virtual)
  
  * `DataBackendRbind`: Combine backends thorugh `task$rbind(backend)` (virtual)
    
---

# Out-of-memory Data

Backends are immutable
  * Filtering rows or selecting columns just modifies the "view" on the data
  * Multiple tasks can share the same backend
    
Example: 
1. Interface a read-only MariaDB with `DataBackendDplyr`
1. Add generated features via `DataBackendDataTable`

---

# Resources

<iframe width="560" height="315" src="https://www.youtube.com/embed/wsP2hiFnDQs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

- [CI Status](https://github.com/mlr-org/mlr3/wiki/CI-Status)
- [Extension packages](https://github.com/mlr-org/mlr3/wiki/Extension-Packages)
- [mlr3book](https://mlr3book.mlr-org.com)

Want to contribute?  
[mlr3.mlr-org.com](https://mlr3.mlr-org.com)


---

https://github.com/mlr-org/mlr3/wiki/CI-Status
https://github.com/mlr-org/mlr3/wiki/Extension-Packages

Want to contribute?  
[mlr3.mlr-org.com](https://mlr3.mlr-org.com)


```{r xaringanthemer, include=FALSE, eval=FALSE}
library(xaringanthemer) # remotes::install_github("gadenbuie/xaringanthemer")
duo_accent(
  outfile = here::here("2019_whyr_warsaw/slides/assets/css/theme.css"),
  primary_color = "#03638e", secondary_color = "#f8f8f8",
  inverse_background_color = "#23373b",
  text_font_google     = google_font("Work Sans", "400", "300"),
  header_font_google   = google_font("Roboto Slab", "400"),
  code_font_google     = google_font("IBM Plex Mono", "300", "400"),
  code_font_size = "0.75em",
  header_h1_font_size = "45px",
  title_slide_background_color = "#002733",
  link_color = "#eb1455",
  text_bold_color = "#00589a",
  text_font_size = "25px",
  header_color = "#002733",
  padding = "0em 2em 1em 2em"
)

extra_css = list(
    ".pkg" = list(
      "color"             = "#53804d",
      "font-weight"       = 300,
      "font-size"         = "95%",
      "font-family"       = "IBM Plex Mono",
      "padding "          = "1px 4px",
      "background-color"  = "#eff4ef",
      "border-radius"     = "4px",
      "border"            = "1px solid #82c878"
    ),
    ".hide-count .remark-slide-number" = list(
      display = "none"
    ),
    ".inverse h1" = list(
      "font-size" = "100px",
      "color" = "white"
    ),
    ".remark-slide-content h1" = list(
      "margin-top" = "10px"
    ),
    "pre" = list(
    "white-space" = "pre-wrap  /* Since CSS 2.1 */",
    "white-space" = "-moz-pre-wrap /* Mozilla, since 1999 */",
    "white-space" = "-pre-wrap  /* Opera 4-6 */",
    "white-space" = "-o-pre-wrap   /* Opera 7 */",
    "word-wrap" = "break-word  /* Internet Explorer 5.5+ */"
    ),
    ".code55" = list(
      "font-size" = "0.55em"
    ),
    ".code75" = list(
      "font-size" = "0.75em"
    ),
    ".code85" = list(
      "font-size" = "0.85em"
    ),
    ".font20" = list(
      "font-size" = "20px"
    ),
    ".avatars" = list(
     "width" = "100px",
     "white-space" = "nowrap",
     "left" = "300px",
     "top" = "30px",
     "position" = "absolute"
    ),
    ".img70 img"= list(
      "max-width"= "70%"
    )
)
write_extra_css(css = extra_css, outfile = here::here("2019_whyr_warsaw/slides/assets/css/extra.css"))
```

